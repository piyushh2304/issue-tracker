<section class="space-y-4">
  <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
    <div>
      <h2 class="text-2xl font-semibold">Issues</h2>
      <p class="text-sm text-gray-600">View, search, filter, sort, create, and update issues.</p>
    </div>
    <div>
      <button (click)="openCreate()" class="inline-flex items-center gap-2 rounded-md bg-black px-4 py-2 text-white hover:bg-gray-800">Create Issue</button>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
    <input [(ngModel)]="search" (ngModelChange)="page=1; fetch()" type="text" placeholder="Search title..." class="md:col-span-2 w-full rounded-md border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black/30" />

    <select [(ngModel)]="status" (change)="page=1; fetch()" class="w-full rounded-md border border-gray-300 px-3 py-2">
      <option value="">All Statuses</option>
      <option value="open">Open</option>
      <option value="in_progress">In Progress</option>
      <option value="resolved">Resolved</option>
      <option value="closed">Closed</option>
    </select>

    <select [(ngModel)]="priority" (change)="page=1; fetch()" class="w-full rounded-md border border-gray-300 px-3 py-2">
      <option value="">All Priorities</option>
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
      <option value="critical">Critical</option>
    </select>

    <select [(ngModel)]="assignee" (change)="page=1; fetch()" class="w-full rounded-md border border-gray-300 px-3 py-2">
      <option value="">All Assignees</option>
      <option *ngFor="let a of assigneeOptions" [value]="a">{{ a }}</option>
    </select>
  </div>

  <div class="overflow-x-auto rounded-md border border-gray-200 bg-white">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50 text-left">
        <tr>
          <th class="px-4 py-3 cursor-pointer" (click)="toggleSort('id')">ID</th>
          <th class="px-4 py-3 cursor-pointer" (click)="toggleSort('title')">Title</th>
          <th class="px-4 py-3 cursor-pointer" (click)="toggleSort('status')">Status</th>
          <th class="px-4 py-3 cursor-pointer" (click)="toggleSort('priority')">Priority</th>
          <th class="px-4 py-3 cursor-pointer" (click)="toggleSort('assignee')">Assignee</th>
          <th class="px-4 py-3 cursor-pointer" (click)="toggleSort('updatedAt')">Updated</th>
          <th class="px-4 py-3">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let issue of issues" class="border-t hover:bg-gray-50">
          <td class="px-4 py-3" (click)="gotoDetail(issue)">{{ issue.id }}</td>
          <td class="px-4 py-3" (click)="gotoDetail(issue)">{{ issue.title }}</td>
          <td class="px-4 py-3" (click)="gotoDetail(issue)">
            <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium"
              [ngClass]="{
                'bg-blue-100 text-blue-700': issue.status === 'open',
                'bg-amber-100 text-amber-700': issue.status === 'in_progress',
                'bg-emerald-100 text-emerald-700': issue.status === 'resolved',
                'bg-gray-200 text-gray-700': issue.status === 'closed'
              }">
              {{ issue.status }}
            </span>
          </td>
          <td class="px-4 py-3" (click)="gotoDetail(issue)">
            <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium"
              [ngClass]="{
                'bg-gray-200 text-gray-700': issue.priority === 'low',
                'bg-sky-100 text-sky-700': issue.priority === 'medium',
                'bg-orange-100 text-orange-700': issue.priority === 'high',
                'bg-rose-100 text-rose-700': issue.priority === 'critical'
              }">
              {{ issue.priority }}
            </span>
          </td>
          <td class="px-4 py-3" (click)="gotoDetail(issue)">{{ issue.assignee || '—' }}</td>
          <td class="px-4 py-3" (click)="gotoDetail(issue)">{{ issue.updatedAt | date:'short' }}</td>
          <td class="px-4 py-3">
            <button (click)="openEdit(issue)" class="rounded-md border px-3 py-1.5 text-xs hover:bg-gray-50">Edit</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="flex items-center justify-between gap-3">
    <div class="text-sm text-gray-600">Total: {{ total }} • Page {{ page }} / {{ totalPages }}</div>
    <div class="flex items-center gap-2">
      <button class="rounded-md border px-3 py-1.5 disabled:opacity-50" [disabled]="page<=1" (click)="page=page-1; fetch()">Prev</button>
      <input type="number" [(ngModel)]="page" (change)="fetch()" class="w-16 rounded-md border px-2 py-1.5" />
      <button class="rounded-md border px-3 py-1.5 disabled:opacity-50" [disabled]="page>=totalPages" (click)="page=page+1; fetch()">Next</button>
      <select [(ngModel)]="pageSize" (change)="page=1; fetch()" class="rounded-md border px-2 py-1.5">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="20">20</option>
        <option [value]="50">50</option>
      </select>
    </div>
  </div>

  <!-- Modal -->
  <div *ngIf="showForm" class="fixed inset-0 z-20 flex items-center justify-center bg-black/40 p-4">
    <div class="w-full max-w-xl rounded-lg bg-white p-6 shadow-xl">
      <h3 class="mb-4 text-lg font-semibold">{{ editId == null ? 'Create Issue' : 'Edit Issue' }}</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <label class="space-y-1">
          <span class="text-sm">Title</span>
          <input [(ngModel)]="form.title" type="text" class="w-full rounded-md border px-3 py-2" />
        </label>
        <label class="space-y-1">
          <span class="text-sm">Assignee</span>
          <input [(ngModel)]="form.assignee" type="text" class="w-full rounded-md border px-3 py-2" />
        </label>
        <label class="space-y-1">
          <span class="text-sm">Status</span>
          <select [(ngModel)]="form.status" class="w-full rounded-md border px-3 py-2">
            <option value="open">Open</option>
            <option value="in_progress">In Progress</option>
            <option value="resolved">Resolved</option>
            <option value="closed">Closed</option>
          </select>
        </label>
        <label class="space-y-1">
          <span class="text-sm">Priority</span>
          <select [(ngModel)]="form.priority" class="w-full rounded-md border px-3 py-2">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </label>
        <label class="md:col-span-2 space-y-1">
          <span class="text-sm">Description</span>
          <textarea [(ngModel)]="form.description" rows="4" class="w-full rounded-md border px-3 py-2"></textarea>
        </label>
      </div>
      <div class="mt-6 flex items-center justify-end gap-2">
        <button class="rounded-md border px-4 py-2" (click)="showForm=false">Cancel</button>
        <button class="rounded-md bg-black px-4 py-2 text-white hover:bg-gray-800" (click)="submitForm()">Save</button>
      </div>
    </div>
  </div>
</section>
